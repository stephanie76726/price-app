<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>報價助手</title>
    <meta name="description" content="專業多幣別利潤報價計算機">
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        * { touch-action: manipulation; }
        /* 自定義 Radio 樣式 */
        .custom-radio:checked + div { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .custom-radio:checked + div .radio-dot { border-color: #4f46e5; border-width: 5px; }
    </style>
</head>
<body class="text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- SVG 圖示 ---
        const IconCalculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>;
        const IconDollar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const IconTrending = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
        const IconArrow = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>;
        const IconInfo = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const IconCalcSmall = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const IconRepeat = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>;

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {children}
            </div>
        );

        const InputGroup = ({ label, value, onChange, prefix = "$", type = "number", step = "0.01", placeholder = "0.00" }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">{label}</label>
                <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">{prefix}</span>
                    <input type={type} step={step} value={value} onChange={(e) => onChange(e.target.value)} className="w-full pl-14 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all font-bold text-slate-700 text-lg" placeholder={placeholder} />
                </div>
            </div>
        );

        const ResultRow = ({ label, twd, usd, rmb, highlight = false }) => (
            <div className={`p-4 rounded-lg border ${highlight ? 'bg-indigo-50 border-indigo-100' : 'bg-white border-slate-100'}`}>
                <div className="flex justify-between items-center mb-3">
                    <span className={`font-bold ${highlight ? 'text-indigo-700' : 'text-slate-700'}`}>{label}</span>
                    {highlight && <span className="text-[10px] bg-indigo-200 text-indigo-800 px-2 py-0.5 rounded-full font-bold">推薦</span>}
                </div>
                <div className="grid grid-cols-3 gap-3 text-sm">
                    <div>
                        <div className="text-[10px] text-slate-400 font-medium mb-0.5">美金報價</div>
                        <div className="font-mono font-bold text-slate-800 text-base">{usd}</div>
                    </div>
                    <div>
                        <div className="text-[10px] text-slate-400 font-medium mb-0.5">人民幣報價</div>
                        <div className="font-mono font-medium text-slate-600 text-base">{rmb}</div>
                    </div>
                    <div>
                        <div className="text-[10px] text-slate-400 font-medium mb-0.5">台幣報價(+5%)</div>
                        <div className="font-mono font-medium text-slate-600 text-base">{twd}</div>
                    </div>
                </div>
            </div>
        );

        function App() {
            // 匯率設定 (ERP 31.13 / 4.43)
            const [rateUSD, setRateUSD] = useState(31.13); 
            const [rateRMB, setRateRMB] = useState(4.43);  
            const [crossRate, setCrossRate] = useState((31.13 / 4.43).toFixed(3));
            const [showSettings, setShowSettings] = useState(false);

            // 產品類型：lan 或 other
            const [productType, setProductType] = useState('other');

            const [costTWD, setCostTWD] = useState('');
            const [costUSD, setCostUSD] = useState('');
            const [costRMB, setCostRMB] = useState('');
            const [rmbTaxType, setRmbTaxType] = useState('untaxed'); 

            const [customPrice, setCustomPrice] = useState('');
            const [customCurrency, setCustomCurrency] = useState('USD');

            const [totalCostTWD, setTotalCostTWD] = useState(0);
            const [calculations, setCalculations] = useState(null);

            const fmt = (num) => num ? new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(num) : '-';

            // 匯率連動邏輯
            useEffect(() => {
                if (rateRMB > 0) {
                    const calculatedCross = rateUSD / rateRMB;
                    if (Math.abs(parseFloat(crossRate) - calculatedCross) > 0.001) {
                        setCrossRate(calculatedCross.toFixed(3));
                    }
                }
            }, [rateUSD, rateRMB]);

            const handleCrossRateChange = (val) => {
                setCrossRate(val);
                const newCross = parseFloat(val);
                if (newCross > 0 && rateUSD > 0) {
                    const newRateRMB = rateUSD / newCross;
                    setRateRMB(newRateRMB);
                }
            };

            // 計算核心
            useEffect(() => {
                const cTWD = parseFloat(costTWD) || 0;
                const cUSD = (parseFloat(costUSD) || 0) * rateUSD;
                
                let cRMB_Input = parseFloat(costRMB) || 0;
                let effectiveRMB = rmbTaxType === 'taxed' ? cRMB_Input / 1.13 : cRMB_Input;
                const cRMB = effectiveRMB * rateRMB;

                const total = cTWD + cUSD + cRMB;
                setTotalCostTWD(total);

                if (total > 0) {
                    // 根據產品類型設定基礎毛利
                    // Other: 33% | LAN: 20%
                    const baseMargin = productType === 'lan' ? 0.20 : 0.33;

                    const calcPrice = (marginPercent) => {
                        const basePriceTWD = total / (1 - marginPercent);
                        return {
                            twd: Math.ceil(basePriceTWD * 1.05),
                            usd: (basePriceTWD / rateUSD).toFixed(2),
                            rmb: (basePriceTWD / rateRMB).toFixed(2),
                            label: `毛利 ${(marginPercent * 100).toFixed(1)}%`
                        };
                    };

                    setCalculations({
                        low: calcPrice(baseMargin),             // 基準 (33% 或 20%)
                        mid: calcPrice(baseMargin * 1.5),       // 1.5倍 (49.5% 或 30%)
                        high: calcPrice(baseMargin * 2)         // 2倍 (66% 或 40%)
                    });
                } else {
                    setCalculations(null);
                }
            }, [costTWD, costUSD, costRMB, rmbTaxType, rateUSD, rateRMB, productType]); 

            const getCustomMarginResult = () => {
                if (!customPrice || !totalCostTWD) return null;
                const price = parseFloat(customPrice);
                if (isNaN(price) || price <= 0) return null;

                let baseRevenueTWD = 0;
                if (customCurrency === 'TWD') baseRevenueTWD = price / 1.05;
                else if (customCurrency === 'USD') baseRevenueTWD = price * rateUSD;
                else if (customCurrency === 'RMB') baseRevenueTWD = price * rateRMB;

                const profit = baseRevenueTWD - totalCostTWD;
                const margin = (profit / baseRevenueTWD) * 100;

                return { margin, profit, baseRevenueTWD };
            };

            const customResult = getCustomMarginResult();
            const handleReset = () => { setCostTWD(''); setCostUSD(''); setCostRMB(''); setRmbTaxType('untaxed'); setCustomPrice(''); };

            return (
                <div className="min-h-screen p-4 pb-20 max-w-lg mx-auto">
                    <div className="space-y-6">
                        {/* Header */}
                        <div className="flex justify-between items-center pt-2">
                            <div className="flex items-center gap-2.5">
                                <div className="bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-200"><IconCalculator /></div>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">報價助手</h1>
                            </div>
                            <button onClick={() => setShowSettings(!showSettings)} className={`flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-bold transition-all ${showSettings ? 'bg-indigo-100 text-indigo-700' : 'bg-white text-slate-500 shadow-sm border border-slate-100'}`}>
                                <IconSettings /> 匯率
                            </button>
                        </div>

                        {/* Settings */}
                        {showSettings && (
                            <div className="bg-white p-5 rounded-2xl border border-indigo-100 shadow-lg space-y-4 animate-fade-in">
                                <div className="flex items-center gap-2 text-indigo-600 border-b border-indigo-50 pb-2">
                                    <IconArrow />
                                    <h3 className="text-xs font-bold uppercase tracking-wider">手動匯率設定</h3>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup label="美金 (USD)" value={rateUSD} onChange={setRateUSD} prefix="1:" />
                                    <InputGroup label="人民幣 (RMB)" value={rateRMB} onChange={setRateRMB} prefix="1:" />
                                </div>
                                <div className="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 mt-2">
                                    <div className="flex items-center gap-2 mb-2 text-indigo-700">
                                        <IconRepeat />
                                        <span className="text-[10px] font-bold uppercase tracking-wider">交叉匯率 (可輸入)</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="text-sm font-bold text-slate-500 whitespace-nowrap">1 USD ≈</div>
                                        <div className="relative w-full">
                                            <input type="number" value={crossRate} onChange={(e) => handleCrossRateChange(e.target.value)} step="0.001" className="w-full px-3 py-2 bg-white border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-indigo-700 font-bold font-mono text-lg" />
                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold">RMB</span>
                                        </div>
                                    </div>
                                    <p className="text-[10px] text-slate-400 mt-2 text-center">*修改交叉匯率將自動調整 RMB 匯率</p>
                                </div>
                            </div>
                        )}

                        {/* Costs */}
                        <Card className="p-5 space-y-4 shadow-md">
                            {/* Product Selection (Radio Style) */}
                            <div className="flex gap-4 pb-2 border-b border-slate-100">
                                <label className="flex-1 cursor-pointer">
                                    <input type="radio" name="productType" checked={productType === 'other'} onChange={() => setProductType('other')} className="custom-radio hidden" />
                                    <div className="flex items-center justify-center gap-2 py-2 px-3 rounded-lg border border-slate-200 text-slate-500 transition-all hover:bg-slate-50">
                                        <div className="radio-dot w-3 h-3 rounded-full border border-slate-300"></div>
                                        <span className="text-sm font-bold">一般產品</span>
                                    </div>
                                </label>
                                <label className="flex-1 cursor-pointer">
                                    <input type="radio" name="productType" checked={productType === 'lan'} onChange={() => setProductType('lan')} className="custom-radio hidden" />
                                    <div className="flex items-center justify-center gap-2 py-2 px-3 rounded-lg border border-slate-200 text-slate-500 transition-all hover:bg-slate-50">
                                        <div className="radio-dot w-3 h-3 rounded-full border border-slate-300"></div>
                                        <span className="text-sm font-bold">網通 (LAN)</span>
                                    </div>
                                </label>
                            </div>

                            <div className="flex justify-between items-center mb-1">
                                <h2 className="font-bold text-lg flex items-center gap-2 text-slate-800"><IconDollar /> 成本結構</h2>
                                <button onClick={handleReset} className="text-xs font-bold text-slate-400 flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-md"><IconRefresh /> 重置</button>
                            </div>
                            <InputGroup label="台幣成本 (TWD)" value={costTWD} onChange={setCostTWD} prefix="NT$" />
                            <InputGroup label="美金成本 (USD)" value={costUSD} onChange={setCostUSD} prefix="US$" />
                            <div className="space-y-2">
                                <div className="flex justify-between items-end">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">人民幣成本 (RMB)</label>
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        <button onClick={() => setRmbTaxType('untaxed')} className={`px-3 py-1 text-[10px] rounded-md font-bold transition-all ${rmbTaxType === 'untaxed' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}>未稅</button>
                                        <button onClick={() => setRmbTaxType('taxed')} className={`px-3 py-1 text-[10px] rounded-md font-bold transition-all ${rmbTaxType === 'taxed' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`}>含稅</button>
                                    </div>
                                </div>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">¥</span>
                                    <input type="number" value={costRMB} onChange={(e) => setCostRMB(e.target.value)} className="w-full pl-14 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-slate-700 text-lg" placeholder="0.00" />
                                </div>
                                {rmbTaxType === 'taxed' && costRMB > 0 && <p className="text-[10px] text-emerald-600 text-right font-medium">*實際成本 (÷1.13): ¥{parseFloat(costRMB / 1.13).toFixed(2)}</p>}
                            </div>
                        </Card>

                        {/* Total & Result */}
                        <div className="space-y-4 pb-10">
                            <div className={`flex justify-between items-center px-2 text-white p-4 rounded-xl shadow-lg transition-colors ${productType === 'lan' ? 'bg-sky-600' : 'bg-slate-800'}`}>
                                <span className="font-bold text-sm opacity-80">總成本 (USD)</span>
                                <span className="text-2xl font-mono font-bold tracking-tight">
                                    $ {totalCostTWD > 0 ? (totalCostTWD / rateUSD).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'}
                                </span>
                            </div>

                            {totalCostTWD > 0 && (
                                <div className="space-y-5">
                                    {/* Reverse Calc */}
                                    <Card className="p-4 border-2 border-emerald-100 bg-emerald-50/30">
                                        <div className="flex items-center gap-2 text-emerald-700 mb-3">
                                            <IconCalcSmall />
                                            <span className="text-xs font-bold uppercase tracking-wider">自訂報價試算 (反算毛利)</span>
                                        </div>
                                        <div className="flex gap-2 mb-3">
                                            <div className="flex-1 relative">
                                                <input type="number" value={customPrice} onChange={(e) => setCustomPrice(e.target.value)} className="w-full pl-3 pr-3 py-3 border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-slate-800 font-bold text-lg" placeholder="輸入欲報價格" />
                                            </div>
                                            <select value={customCurrency} onChange={(e) => setCustomCurrency(e.target.value)} className="px-2 py-2 border border-emerald-200 rounded-lg bg-white text-slate-700 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                                                <option value="USD">USD</option>
                                                <option value="RMB">RMB</option>
                                                <option value="TWD">TWD</option>
                                            </select>
                                        </div>
                                        {customResult ? (
                                            <div className="bg-white rounded-lg p-3 border border-emerald-100 grid grid-cols-2 gap-4 shadow-sm">
                                                <div>
                                                    <div className="text-[10px] text-slate-400 mb-0.5 font-bold">預估毛利率</div>
                                                    <div className={`font-black text-xl ${customResult.margin < 0 ? 'text-red-500' : 'text-emerald-600'}`}>{customResult.margin.toFixed(2)}%</div>
                                                </div>
                                                <div>
                                                    <div className="text-[10px] text-slate-400 mb-0.5 font-bold">預估淨利 (TWD)</div>
                                                    <div className={`font-mono font-bold text-sm ${customResult.profit < 0 ? 'text-red-500' : 'text-slate-700'}`}>NT$ {new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(customResult.profit)}</div>
                                                </div>
                                            </div>
                                        ) : <p className="text-[10px] text-slate-400 text-center py-2 font-medium">輸入價格以計算實際毛利</p>}
                                    </Card>

                                    {/* Quote List */}
                                    <div className="space-y-3">
                                        <div className={`flex items-center gap-2 mb-1 px-1 ${productType === 'lan' ? 'text-sky-600' : 'text-indigo-600'}`}>
                                            <IconTrending />
                                            <span className="text-xs font-bold uppercase tracking-wider">
                                                {productType === 'lan' ? 'LAN 網通建議報價 (20%起)' : '一般建議報價 (33%起)'}
                                            </span>
                                        </div>
                                        <ResultRow 
                                            label={calculations.low.label}
                                            twd={`NT$ ${fmt(calculations.low.twd)}`} 
                                            usd={`$ ${calculations.low.usd}`} 
                                            rmb={`¥ ${calculations.low.rmb}`} 
                                        />
                                        <ResultRow 
                                            label={calculations.mid.label}
                                            twd={`NT$ ${fmt(calculations.mid.twd)}`} 
                                            usd={`$ ${calculations.mid.usd}`} 
                                            rmb={`¥ ${calculations.mid.rmb}`} 
                                            highlight={true} 
                                        />
                                        <ResultRow 
                                            label={calculations.high.label}
                                            twd={`NT$ ${fmt(calculations.high.twd)}`} 
                                            usd={`$ ${calculations.high.usd}`} 
                                            rmb={`¥ ${calculations.high.rmb}`} 
                                        />
                                    </div>
                                    <div className="flex gap-2 p-3 bg-blue-50 text-blue-700 text-[10px] rounded-lg font-medium">
                                        <IconInfo />
                                        <p>台幣報價含5%稅，總成本顯示為USD。</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
